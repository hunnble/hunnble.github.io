
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<link rel="alternate" href="/atom.xml" type="application/atom+xml">
<title>async库waterfall源码分析 [ 北方公园 ]</title>
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/default_highlight.min.css">
<link rel="stylesheet" href="/libs/fancybox/source/jquery.fancybox.css" type="text/css" media="screen">
<link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="navbar-fixed white-text">
<nav class="transparent z-depth-0">
<div class="nav-wrapper">
<ul id="nav-mobile" class="right hide-on-med-and-down">
<li>
<a class="waves-effect text-lighten-4" href="/">主页</a>
</li>
<li>
<a class="waves-effect text-lighten-4" href="/archive">归档</a>
</li>
<li>
<a class="waves-effect text-lighten-4" href="/about">关于</a>
</li>
</ul>
<a href="#" data-activates="slide-nav" class="button-collapse text-lighten-4" id="side-nav-switcher"><i class="material-icons">menu</i></a>
</div>
</nav>
</div>
<ul id="slide-nav" class="side-nav">
<li>
<div class="userView lighten-2 teal">
<div class="background">
<h5 class="white-text inline-title">Noski</h5>
</div>
<img class="circle" src="/images/avatar.png">
<h5 class="white-text inline-title">北方公园</h5>
<br>
<h5 class="white-text inline-title">Web/书和思考/一派胡言</h5>
</div>
</li>
<li><a class="waves-effect lighten-2 teal-text" href="/">主页</a></li>
<li><a class="waves-effect lighten-2 teal-text" href="/archive">归档</a></li>
<li><a class="waves-effect lighten-2 teal-text" href="/about">关于</a></li>
</ul>
<div class="parallax-container valign-wrapper hide-on-small-only" style="height:400px">
<div class="parallax lighten-2 teal">
<img src="/images/background.jpg">
</div>
<script type="text/javascript">var container=document.querySelector(".parallax-container"),tmpTitle=container.querySelector(".hide-on-image-load"),img=container.querySelector("img");img.onload=function(){tmpTitle&&(tmpTitle.style.display="none")}</script>
</div>
<main id="container-outer" class="">
<div class="row">
<div class="col s12 m10 push-m1 l8 push-l2" id="container-inner">
<section id="post" class="card article z-depth-0">
<div class="card-panel z-depth-0 black-text">
<h1>async库waterfall源码分析</h1>
<div class="valign-wrapper blue-grey-text">
<i class="material-icons valign">query_builder</i>&nbsp
<time datetime="2016-06-21T14:32:49.000Z" class="valign">
2016 6月 21日 晚上10:32:49
</time>
</div>
<div class="valign-wrapper sm-text blue-grey-text">
<i class="material-icons valign">grade</i>&nbsp
<span id="busuanzi_container_page_pv" class="valign">
阅读<span id="busuanzi_value_page_pv"></span>次
</span>
</div>
<div class="section right">
<span class="new badge amber left" data-badge-caption="">
<a href="/tag/node-js/" title="#node.js" class="white-text" target="_blank" rel="external">#node.js</a>
</span>
</div>
</div>
<div class="card-content z-depth-0">
<p>今天重构node.js博客代码的时候为了把好几层的嵌套消除就使用了大名鼎鼎的aysnc库中的waterfall函数。<a id="more"></a>使用async前画风是这样:<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">User.prototype.get = <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</div><div class="line">    mongodb.open(<span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">            <span class="keyword">return</span> callback(err);</div><div class="line">        &#125;</div><div class="line">        db.collection(DBNAME, <span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) &#123;</div><div class="line">                mongodb.close();</div><div class="line">                <span class="keyword">return</span> callback(err);</div><div class="line">            &#125;</div><div class="line">            collection.findOne(&#123;</div><div class="line">                <span class="attr">name</span>: name</div><div class="line">            &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">                mongodb.close();</div><div class="line">                <span class="keyword">if</span> (err) &#123;</div><div class="line">                    <span class="keyword">return</span> callback(err);</div><div class="line">                &#125;</div><div class="line">                callback(<span class="literal">null</span>, user);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p>
<p>使用async后画风变成这样:<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">User.prototype.get = <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</div><div class="line">    <span class="keyword">async</span>.waterfall([</div><div class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</div><div class="line">            mongodb.open(<span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</div><div class="line">                cb(err, db);</div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">db, cb</span>) </span>&#123;</div><div class="line">            db.collection(DBNAME, <span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</div><div class="line">                cb(err, collection);</div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">collection, cb</span>) </span>&#123;</div><div class="line">            collection.findOne(&#123;</div><div class="line">                <span class="attr">name</span>: name</div><div class="line">            &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">                cb(err, user);</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    ], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">if</span>(err) &#123;</div><div class="line">            <span class="keyword">return</span> callback(err);</div><div class="line">        &#125;</div><div class="line">        callback(<span class="literal">null</span>, result[<span class="number">0</span>]);</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p>
<p>哈哈哈！<br>那么waterfall的源码长这样:<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span>.waterfall = <span class="function"><span class="keyword">function</span> (<span class="params">tasks, callback</span>) </span>&#123;</div><div class="line">        callback = callback || <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">        <span class="keyword">if</span> (!_isArray(tasks)) &#123;</div><div class="line">          <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'First argument to waterfall must be an array of functions'</span>);</div><div class="line">          <span class="keyword">return</span> callback(err);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!tasks.length) &#123;</div><div class="line">            <span class="keyword">return</span> callback();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> wrapIterator = <span class="function"><span class="keyword">function</span> (<span class="params">iterator</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) &#123;</div><div class="line">                    callback.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</div><div class="line">                    callback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</div><div class="line">                    <span class="keyword">var</span> next = iterator.next();</div><div class="line">                    <span class="keyword">if</span> (next) &#123;</div><div class="line">                        args.push(wrapIterator(next));</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> &#123;</div><div class="line">                        args.push(callback);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">async</span>.setImmediate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                        iterator.apply(<span class="literal">null</span>, args);</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">        &#125;;</div><div class="line">        wrapIterator(<span class="keyword">async</span>.iterator(tasks))();</div><div class="line">    &#125;;</div></pre></td></tr></table></figure><p></p>
<p>其中的iterator函数是:<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span>.iterator = <span class="function"><span class="keyword">function</span> (<span class="params">tasks</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> makeCallback = <span class="function"><span class="keyword">function</span> (<span class="params">index</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> fn = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (tasks.length) &#123;</div><div class="line">                    tasks[index].apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> fn.next();</div><div class="line">            &#125;;</div><div class="line">            fn.next = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> (index &lt; tasks.length - <span class="number">1</span>) ? makeCallback(index + <span class="number">1</span>): <span class="literal">null</span>;</div><div class="line">            &#125;;</div><div class="line">            <span class="keyword">return</span> fn;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> makeCallback(<span class="number">0</span>);</div><div class="line">    &#125;;</div></pre></td></tr></table></figure><p></p>
<p>waterfall开头先对第一个参数做限制，必须是function数组，接下来的wrapIterator封装了iterator，执行后返回的是一个匿名function。其明确的参数只有一个err。当err不为空的时候，直接执行callback function。否则从index为1开始取出参数列表，并把iterator的下一个function包装之后push到args中（如果没有下一个function了则push回调函数）。接下来，则执行当前的iterator，执行的参数是下一个iterator function（作为这一步的回调函数）以及参数（如果当前的iterator被调用时传递了其他参数）。这样在当前iterator中回调下一个iterator，依次迭代执行，直至执行完所有function和callback。</p>
<div class="sibling-post center-align card-panel z-depth-0 section">
<a href="/2016/06/17/HTTP状态码/" class="btn-flat blue-grey-text right">
<i class="material-icons right">chevron_right</i>
HTTP状态码
</a>
<a href="/2016/06/24/ES6-let-and-const/" class="btn-flat blue-grey-text left">
<i class="material-icons left">chevron_left</i>
ES6-let and const
</a>
</div>
<div class="comment" id="duoshuo">
<div class="ds-thread" data-thread-key="post-async库waterfall源码分析" data-title="async库waterfall源码分析" data-url="http://hunnble.github.io/2016/06/21/async库waterfall源码分析/"></div>
<script type="text/javascript">var duoshuoQuery={short_name:"hunnble"},ds=document.createElement("script");ds.type="text/javascript",ds.async=!0,ds.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",ds.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(ds)</script>
</div>
</div>
</section>
<div class="fixed-action-btn click-to-toggle">
<a class="btn-floating btn-large lighten-2 teal">
<i class="large material-icons">view_module</i>
</a>
<ul>
<li>
<a id="back-to-top" class="btn-floating lighten-2 teal waves-effect %>" href="#">
<i class="material-icons">navigation</i>
</a>
</li>
</ul>
</div>
</div>
<aside class="col m2 push-m2 hide-on-med-and-down">
<div class="toc transparent card-panel z-depth-0">
</div>
</aside>
</div>
</main>
<footer class="page-footer lighten-2 teal">
<div class="container section">
<div class="center-align white-text text-lighten-4">
<p>
Powerd by <a href="https://hexo.io/zh-cn/" title="hexo" target="_blank" rel="external">hexo</a>. Theme by <a href="https://github.com/hunnble/hexo-theme-immortal" title="immortal" target="_blank" rel="external">immortal</a>.
</p>
<h5>
总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
总访客数&nbsp;<span id="busuanzi_value_site_uv"></span>
</h5>
</div>
</div>
<div class="footer-copyright center-align">
Copyright © 2016 Noski
</div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="/js/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/materialize/0.97.8/js/materialize.min.js"></script>
<script type="text/javascript" src="/libs/fancybox/source/jquery.fancybox.pack.js"></script>
<script type="text/javascript" src="/js/main.js"></script>
</body>
</html>
